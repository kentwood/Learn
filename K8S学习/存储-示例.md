## 案例一：临时存储与配置共享
- 场景：一个 Web 应用需要在 Pod 内的多个容器间共享临时数据，同时需要加载配置文件和敏感信息（如数据库密码）。
- 涉及知识点：
  - emptyDir：Pod 内容器间共享临时数据，支持内存存储和大小限制
  - configMap：存储非敏感配置，可挂载为文件或环境变量
  - secret：存储敏感信息，自动 base64 解码，建议设为只读
  - 多容器共享存储的方式
```yaml
# 1. 创建配置文件ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-config
data:
  app.conf: |
    server.port=8080
    log.level=info
  index.html: |
    <h1>Welcome to My App</h1>

---
# 2. 创建敏感信息Secret
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
type: Opaque
data:
  username: YWRtaW4=  # base64编码的"admin"
  password: cGFzc3dvcmQxMjM=  # base64编码的"password123"

---
# 3. 创建使用上述存储的Pod
apiVersion: v1
kind: Pod
metadata:
  name: web-app
spec:
  containers:
  - name: web-server
    image: nginx:alpine
    ports:
    - containerPort: 80
    volumeMounts:
    - name: temp-data  # 临时数据共享目录
      mountPath: /tmp/shared
    - name: config-files  # 挂载配置文件
      mountPath: /etc/config
    - name: html-content  # 挂载静态页面
      mountPath: /usr/share/nginx/html
    - name: db-secrets  # 挂载敏感信息
      mountPath: /etc/secrets
      readOnly: true  # 敏感信息只读

  - name: sidecar
    image: busybox:1.35
    command: ["sh", "-c", "while true; do echo $(date) >> /tmp/shared/access.log; sleep 10; done"]
    volumeMounts:
    - name: temp-data  # 与web-server共享临时目录
      mountPath: /tmp/shared

  volumes:
  - name: temp-data
    emptyDir:  # 临时存储，Pod生命周期内有效
      medium: Memory  # 存储在内存中（可选，默认使用磁盘）
      sizeLimit: 100Mi  # 限制大小

  - name: config-files
    configMap:  # 挂载ConfigMap
      name: web-config
      items:
      - key: app.conf
        path: app.conf

  - name: html-content
    configMap:  # 挂载ConfigMap中的静态文件
      name: web-config
      items:
      - key: index.html
        path: index.html

  - name: db-secrets
    secret:  # 挂载Secret
      secretName: db-credentials
    
```

## 案例二：单节点持久化存储
- 场景：一个单节点部署的数据库（如 SQLite）需要持久化存储数据，避免 Pod 重启后数据丢失。
- 涉及知识点
  - PersistentVolume：集群级存储资源，定义存储容量、访问模式和回收策略
  - PersistentVolumeClaim：用户对存储的请求，需与 PV 的访问模式、存储类别匹配
  - ReadWriteOnce访问模式：适合单节点使用的存储
  - hostPath：节点本地存储（生产环境慎用，推荐用 CSI）
  - PV/PVC 静态绑定的匹配规则
```yaml
# 1. 创建PersistentVolume（集群级资源）
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sqlite-pv
spec:
  capacity:
    storage: 10Gi  # 存储容量
  accessModes:
  - ReadWriteOnce  # 仅允许单个节点读写
  persistentVolumeReclaimPolicy: Retain  # 保留数据，手动回收
  storageClassName: manual  # 存储类别
  hostPath:  # 使用节点本地路径（仅单节点测试用）
    path: /data/sqlite  # 节点上的实际路径
    type: DirectoryOrCreate  # 若路径不存在则创建

---
# 2. 创建PersistentVolumeClaim（命名空间级资源）
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sqlite-pvc
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce  # 需与PV匹配
  resources:
    requests:
      storage: 5Gi  # 请求容量（小于等于PV容量）
  storageClassName: manual  # 需与PV匹配

---
# 3. 创建使用PVC的Pod
apiVersion: v1
kind: Pod
metadata:
  name: sqlite-db
spec:
  containers:
  - name: sqlite
    image: nouchka/sqlite3:latest
    command: ["sqlite3", "/data/db.sqlite", "SELECT 1;"]
    volumeMounts:
    - name: data-volume
      mountPath: /data  # 数据库文件存储路径
  volumes:
  - name: data-volume
    persistentVolumeClaim:
      claimName: sqlite-pvc  # 绑定到PVC
  nodeSelector:  # 限制调度到特定节点（确保能访问hostPath）
    kubernetes.io/hostname: worker-node-1
    
```

## 案例三：动态存储供应（StorageClass）
- 场景：在云环境中部署应用，需要自动创建和管理存储资源，避免手动创建 PV。
- 涉及知识点：
  - StorageClass：动态供应 PV 的模板，定义存储类型和供应者
  - CSI 驱动：通过provisioner指定存储后端（这里是 AWS EBS CSI）
  - 动态供应流程：创建 PVC 时自动触发 PV 创建和绑定
  - 存储加密：通过参数配置存储加密
  - 存储扩容：allowVolumeExpansion允许后续扩展 PVC 容量
```yaml
# 1. 创建StorageClass（以AWS EBS为例）
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: aws-ebs-gp3
provisioner: ebs.csi.aws.com  # AWS EBS的CSI驱动
parameters:
  type: gp3  # 通用型SSD
  fsType: ext4  # 文件系统类型
  encrypted: "true"  # 启用加密
reclaimPolicy: Delete  # PVC删除后自动删除PV
allowVolumeExpansion: true  # 允许存储扩容
volumeBindingMode: Immediate  # 立即绑定

---
# 2. 创建使用StorageClass的PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-dynamic-pvc
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: aws-ebs-gp3  # 关联到StorageClass

---
# 3. 部署使用动态PVC的应用
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-with-dynamic-storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dynamic-app
  template:
    metadata:
      labels:
        app: dynamic-app
    spec:
      containers:
      - name: app
        image: nginx:alpine
        volumeMounts:
        - name: data-volume
          mountPath: /usr/share/nginx/html
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: app-dynamic-pvc
    
```