## 简介
在 Kubernetes（K8s）中，存储管理是支撑状态 ful 应用（如数据库、消息队列等）的核心能力。由于容器本身是临时的（生命周期与 Pod 绑定），K8s 设计了一套完整的存储体系，用于实现数据的持久化、共享和动态管理。以下从核心概念、组件、类型及最佳实践等方面全面介绍 K8s 存储。

## 面临的问题
容器的 “临时性” 导致两大问题：

- 数据丢失：容器重启后，内部文件系统的修改会被重置。
- 数据共享：Pod 内多个容器或跨 Pod 之间需要共享数据。

## 核心目标
- 持久化：确保数据在容器 / Pod 生命周期外仍能保留。
- 抽象与解耦：将存储资源与 Pod 逻辑分离（管理员管存储，用户管使用）。
- 动态化：支持自动创建 / 分配存储资源，减少手动操作。
- 标准化：通过接口兼容不同存储后端（本地磁盘、网络存储、云存储等）。

## 核心概念
### 1. Volume卷
Volume 是 K8s 中最基础的存储单元，与 Pod 生命周期绑定（Pod 销毁，Volume 也会被清理，除非是持久化类型）。它本质是一个目录，可被 Pod 内所有容器挂载和共享。
**关键特性：由 Pod 定义中的 volumes 字段声明，容器通过 volumeMounts 挂载到内部路径。
支持多种 “卷类型”，适配不同存储场景。**
```yaml
## 示例
apiVersion: v1
kind: Pod
metadata:
  name: sqlite-db
spec:
  containers:
  - name: sqlite
    image: nouchka/sqlite3:latest
    command: ["sqlite3", "/data/db.sqlite", "SELECT 1;"]
    volumeMounts:
    - name: data-volume
      mountPath: /data  # 数据库文件存储路径
  volumes:
  - name: data-volume
    persistentVolumeClaim:
      claimName: sqlite-pvc  # 绑定到PVC
  nodeSelector:  # 限制调度到特定节点（确保能访问hostPath）
    kubernetes.io/hostname: worker-node-1
```

常见的卷类型
卷类型	|含义与用途	|特点
---|---|---
emptyDir	|Pod 启动时创建的临时目录，用于 Pod 内容器共享数据（如缓存、临时文件）。	|存储在节点本地（内存或磁盘），Pod 销毁后删除。
hostPath	|将节点（Node）的本地文件系统路径挂载到 Pod 内。	|数据可在 Pod 重启后保留（依赖节点），但跨节点不共享，适合单节点测试。
nfs	|挂载外部 NFS（网络文件系统）共享目录。	|支持跨节点共享，适合简单分布式存储场景。
configMap/secret	|将配置文件（ConfigMap）或敏感信息（Secret）以文件形式挂载到 Pod 内。	|动态更新配置，无需重启 Pod（ConfigMap 支持热更新）。
persistentVolumeClaim（PVC）	|绑定到 PersistentVolume（PV），实现持久化存储（核心类型）。	|数据独立于 Pod 生命周期，支持跨节点共享。
CSI	|通过容器存储接口（CSI）挂载第三方存储（如 Ceph、AWS EBS、Azure Disk 等）。	|标准化接口，支持几乎所有主流存储系统。

### 2. PersistentVolume（PV）：集群级别的持久化存储资源
PV 是集群管理员提前创建的 “持久化存储资源”（如一块磁盘、一个 NFS 目录），独立于 Pod 生命周期，属于集群级资源（不绑定命名空间）。
#### 核心属性
- 存储容量（capacity）：如 storage: 10Gi。
- 访问模式（accessModes）：定义 PV 可被如何访问（重要！）：
  - ReadWriteOnce（RWO）：仅允许单个节点以读写方式挂载。
  - ReadOnlyMany（ROX）：允许多个节点以只读方式挂载。
  - ReadWriteMany（RWX）：允许多个节点以读写方式挂载（需存储后端支持，如 NFS、CephFS）。
- 回收策略（persistentVolumeReclaimPolicy）：PV 与 PVC 解绑后的处理方式：
  - Retain：保留数据，需手动清理（安全，适合生产）。
  - Delete：自动删除 PV 及关联存储（适合云存储，如 EBS）。
  - Recycle：清空数据后重新可用（已废弃，推荐用 Retain）。
- 存储类别（storageClassName）：关联到 StorageClass，用于动态供应。
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sqlite-pv
spec:
  capacity:
    storage: 10Gi  # 存储容量
  accessModes:
  - ReadWriteOnce  # 仅允许单个节点读写
  persistentVolumeReclaimPolicy: Retain  # 保留数据，手动回收
  storageClassName: manual  # 存储类别
  hostPath:  # 使用节点本地路径（仅单节点测试用）
    path: /data/sqlite  # 节点上的实际路径
    type: DirectoryOrCreate  # 若路径不存在则创建
```

### 3. PersistentVolumeClaim（PVC）：用户对存储的 “请求”
PVC 是用户对存储资源的 “申请单”，由用户创建（属于命名空间级资源），用于声明需要的存储容量、访问模式等。K8s 会自动匹配满足条件的 PV 并绑定（静态绑定），或通过 StorageClass 动态创建 PV（动态供应）。
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-pvc
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce  # 要求PV支持RWO
  resources:
    requests:
      storage: 10Gi  # 申请10Gi存储
  storageClassName: "manual"  # 关联StorageClass（可选）
```
**关联逻辑：PVC 必须与 PV 的 accessModes、storageClassName 匹配，且请求容量 ≤ PV 容量才能绑定。**

### 4. StorageClass：动态供应 PV 的 “模板”
StorageClass 用于实现 PV 的 “动态供应”（Dynamic Provisioning），避免管理员手动创建大量 PV。它定义了存储的 “类型” 和 “供应者”（如云厂商存储、CSI 驱动），当用户创建 PVC 时，K8s 会根据 storageClassName 自动调用对应的驱动创建 PV 并绑定。
#### 核心属性
- provisioner：存储供应者（如 kubernetes.io/aws-ebs、rook.io/ceph、local）。
- parameters：供应存储的参数（如磁盘类型 type: gp2、文件系统 fsType: ext4）。
- reclaimPolicy：动态创建的 PV 的默认回收策略（默认 Delete）。
```yaml
# 示例（AWS EBS 存储类）：
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: aws-ebs-gp2
provisioner: kubernetes.io/aws-ebs  # AWS EBS供应者
parameters:
  type: gp2  # 通用型SSD
  fsType: ext4  # 文件系统类型
reclaimPolicy: Delete  # PVC删除后自动删除PV
allowVolumeExpansion: true  # 允许扩容
```

